@{
    ViewData["Title"] = "Jadwal Petugas";
}
<div class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Jadwal Petugas Harian</h4>
                    </div>
                    <div class="card-body">
                        <a class="btn btn-primary btn-tambah" asp-controller="JadwalPetugas" asp-action="Create">Tambah Data</a>

                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th scope="col">Petugas Harian</th>
                                        <th scope="col">Tanggal</th>
                                        <th scope="col">Waktu</th>
                                        <th scope="col">Tugas</th>
                                        <th scope="col">Status</th>
                                        <th scope="col">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        loadTable();

        function loadTable() {
            var hostname = "https://localhost:44307/";
            var url = hostname + "GetAllJadwalPetugasHarian";
            var method = "GET";

            function getStatusDescription(status) {
                switch (status) {
                    case 0:
                        return "Tidak Aktif";
                    case 1:
                        return "Aktif";
                    case 2:
                        return "Terlaksana";
                    default:
                        return "Unknown Status";
                }
            }

            $.ajax({
                url: url,
                method: method,
                contentType: "application/json",
                success: function (data) {
                    var list = data.data;
                    list.forEach(function (item) {

                        var statusDescription = getStatusDescription(item.status);

                        // Call loadNamaPetugas with a callback function
                        loadNamaPetugas(item.kode, function (nama) {
                            // Continue processing once the nama is obtained
                            console.log(nama);

                            // Rest of your code here...
                            var options = { year: 'numeric', month: 'long', day: 'numeric' };
                            var formatter = new Intl.DateTimeFormat('id-ID', options);
                            var formattedTanggal = formatter.format(new Date(item.tanggal));

                            var newRow =
                                "<tr align='center'>" +
                                "<td>" + nama + "</td>" +
                                "<td>" + formattedTanggal + "</td>" +
                                "<td>" + item.waktu + "</td>" +
                                "<td>" + item.tugas + "</td>" +
                                "<td>" + statusDescription + "</td>" +
                                "<td>" +
                                '<a class="btn btn-secondary" href="/JadwalPetugas/Update?id_jadwal=' + item.id_jadwal + '">Update</a>' +
                                '<button class="btn btn-warning" value = "' + item.id_jadwal + '" onclick = "ubahStatus(this.value)">Batal</button>' +
                                '<button class="btn btn-success" value="' + item.id_jadwal + '" onclick="ubahStatusTerlaksana(this.value)">Terlaksana</button>' +
                                "</td>" +
                                "</tr>";
                            $("#tbody").append(newRow);
                        });
                    });
                },
            });
        }

        function loadNamaPetugas(kode, callback) {
            var hostname = "https://localhost:44307/";
            var url = hostname + "GetPetugasHarian?kode=" + kode;
            var method = "GET";



            $.ajax({
                url: url,
                method: method,
                contentType: "application/json",
                success: function (data) {
                    var item = data.data;
                    var result = item.nama;

                    // Invoke the callback function with the result
                    callback(result);
                },
            });
        }

        function ubahStatus(id_jadwal) {
            console.log("Preparing to update status for id_jadwal:", id_jadwal, "to status:", status);

            // Confirm with the user before updating the status
            var confirmationMessage = status === 0 ? "Apakah Anda yakin ingin membatalkan?" : "Apakah Anda yakin tugas sudah terlaksana?";
            if (!confirm(confirmationMessage)) {
                console.log("Status update canceled.");
                return;
            }

            var hostname = "https://localhost:44307/";
            var url = hostname + "UpdateStatus?id_jadwal=" + id_jadwal;
            var status = 0;
            var method = "PUT";

            // Data to send in the request body
            var data = {
                id_jadwal: id_jadwal,
                status: status
            };

            console.log("Sending data:", data);

            $.ajax({
                url: url,
                method: method,
                contentType: "application/json",
                data: JSON.stringify(data), // Convert data to JSON string
                success: function (data) {
                    console.log("Status update successful:", data);
                    alert("Status Jadwal Petugas Harian Berhasil Diubah");
                    // Reload the page
                    location.reload();
                },
                error: function (xhr, textStatus, errorThrown) {
                    // Handle errors appropriately, e.g., show an error message
                    console.error("Error updating status:", errorThrown);
                    alert("Gagal mengubah status. Error: " + errorThrown);
                }
            });
        }


        function ubahStatusTerlaksana(id_jadwal) {
            console.log("Preparing to update status for id_jadwal:", id_jadwal, "to status: Terlaksana");

            // Confirm with the user before updating the status
            var confirmationMessage = "Apakah Anda yakin tugas sudah terlaksana?";
            if (!confirm(confirmationMessage)) {
                console.log("Status update canceled.");
                return;
            }

            var hostname = "https://localhost:44307/";
            var url = hostname + "UpdateStatus?id_jadwal=" + id_jadwal;
            var status = "Terlaksana"; // Assuming 2 represents "Terlaksana"
            var method = "PUT";

            // Data to send in the request body
            var data = {
                id_jadwal: id_jadwal,
                status: status
            };

            console.log("Sending data:", data);

            $.ajax({
                url: url,
                method: method,
                contentType: "application/json",
                data: JSON.stringify(data), // Convert data to JSON string
                success: function (data) {
                    console.log("Status update successful:", data);
                    alert("Status Jadwal Petugas Harian Berhasil Diubah");
                    // Reload the page
                    location.reload();
                },
                error: function (xhr, textStatus, errorThrown) {
                    // Handle errors appropriately, e.g., show an error message
                    console.error("Error updating status:", errorThrown);
                    alert("Gagal mengubah status. Error: " + errorThrown);
                }
            });
        }





    </script>
</div>
